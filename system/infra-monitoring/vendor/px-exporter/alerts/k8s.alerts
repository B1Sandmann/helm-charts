groups:
- name: alerts for PX kubernetes resources
  rules:
  - alert: PXRoutingServiceOnRisk
    expr: sum
      by (px_service) (label_replace((sum by (pod) ((kube_pod_info{namespace="px"} * on(node) group_left() sum by(node) (kube_node_status_condition{node=~"^px.+",condition="Ready",status="true"})
      * on(pod) group_left() sum by(pod) (kube_pod_status_phase{namespace="px", phase="Running"})
      == 1) * on(pod) group_left() sum by(pod) (kube_pod_status_ready{namespace="px", condition="true"}))), "px_service", "$1", "pod", ".+-pxrs-[0-9]-s([0-9])-[0-9].+"))
      <= 1
    for: 10 min
    labels:
      severity: warning
      tier: k8s
      service: k8s
      context: px
    annotations:
      description: "TEST ALERT - PLEASE IGNORE - Pod px /{{ $labels.pod }} is not ready for more than 2h"
      summary: "TEST ALERT - PLEASE IGNORE - Pod not ready for a long time"

  - alert: PXPodNotReady
    expr: sum
      by(pod) ((kube_pod_info{namespace="px"} * on(node) group_left() sum by(node) (kube_node_status_condition{node=~"^px.+",condition="Ready",status="true"})
      * on(pod) group_left() sum by(pod) (kube_pod_status_phase{namespace="px", phase="Running"})
      == 1) * on(pod) group_left() sum by(pod) (kube_pod_status_ready{namespace="px", condition="true"}))
      == 0
    for: 2h
    labels:
      severity: warning
      tier: k8s
      service: k8s
      context: px
    annotations:
      description: "TEST ALERT - PLEASE IGNORE - Pod px /{{ $labels.pod }} is not ready for more than 2h"
      summary: "TEST ALERT - PLEASE IGNORE - Pod not ready for a long time"

  - alert: PXPodRestartingTooMuch
    expr: sum
      by(pod, container) (rate(kube_pod_container_status_restarts_total{namespace="px"}[15m]))
      > 0
    for: 1h
    labels:
      severity: info
      tier: k8s
      service: k8s
      context: px
    annotations:
      description: "TEST ALERT - PLEASE IGNORE - Container {{ $labels.container }} of pod px /{{ $labels.pod }} is restarting constantly"
      summary: "TEST ALERT - PLEASE IGNORE - Pod is in a restart loop"

  - alert: PXNodeNotReady
    expr: sum by (node)(kube_node_status_condition{node=~"^px.+",condition="Ready",status="true"}) == 0
    for: 1h
    labels:
      severity: critical
      tier: k8s
      service: k8s
      context: node
      dashboard: nodes?var-server={{$labels.node}}
      playbook: docs/support/playbook/kubernetes/k8s_node_not_ready.html
    annotations:
      description: "TEST ALERT - PLEASE IGNORE - Node {{ $labels.node }} is NotReady for more than an hour"
      summary: "TEST ALERT - PLEASE IGNORE - Node status is NotReady"

  - alert: PXNodeNotReadyFlapping
    expr: changes(kube_node_status_condition{node=~"^px.+",condition="Ready",status="true"}[15m]) > 2
    for: 1h
    labels:
      severity: info
      tier: k8s
      service: k8s
      context: node
      meta: '{{ $labels.node }}'
      dashboard: nodes?var-server={{$labels.node}}
    annotations:
      description: "TEST ALERT - PLEASE IGNORE - Node {{ $labels.node }} is flapping between Ready and NotReady"
      summary: "TEST ALERT - PLEASE IGNORE -  Node readiness is flapping"