groups:
- name: nova
  rules:
  - record: OpenstackDVSPolling
    expr: min(rate(openstack_networking_dvs_plugins_ml2_drivers_mech_dvs_agent_dvs_agent_process_ports_timer_count[5m]))
          BY (kubernetes_pod_name) * 60 < 1

  - record: OpenstackDVSSecGroup
    expr: max(openstack_networking_dvs_security_group_updates_timer{quantile="0.99"}) BY (kubernetes_pod_name) > 60

  - record: OpenstackDVSSecurityGroupTooManyRules
    expr: max(max(openstack_networking_dvs__apply_changed_sg_aggr_security_group_rules) by (host,security_group,port_group,project_id)) > 3000

  - record: OpenstackNovaMaxDiskUsagePerc
    expr: (sum(avg(openstack_compute_nodes_local_gb_used_gauge{host!~".*ironic.*",availability_zone!~"true|false"}) by (host,availability_zone)) by (availability_zone)) / (sum(avg(openstack_compute_nodes_local_gb_gauge{host!~".*ironic.*",availability_zone!~"true|false"}) by (host,availability_zone)) by (availability_zone)) > 0.95

  - record: OpenstackNovaMaxRAMUsagePerc
    expr: (sum(avg(openstack_compute_nodes_memory_mb_used_gauge{host!~".*ironic.*",availability_zone!~"true|false"}) by (host,availability_zone)) by (availability_zone)) / (sum(avg(openstack_compute_nodes_memory_mb_gauge{host!~".*ironic.*",availability_zone!~"true|false"}) by (host,availability_zone)) by (availability_zone)) > 0.95

  - record: OpenstackNovaInstanceInErrorState
    expr: sum(openstack_compute_instance_created_in_24hrs_gauge{vm_state='error'})by(uuid,host) > 0

  - record: OpenstackNovaInstanceStuckBuilding
    expr: sum(openstack_compute_stuck_instances_count_gauge{host!~"nova-compute-ironic.*",vm_state="building"}) BY (host) > 0

  - record: OpenstackNovaInstanceStuckDeleting
    expr: sum(openstack_compute_stuck_instances_count_gauge{vm_state="deleting"}) BY (host) > 0

  - record: OpenstackNovaInstanceStuckStopping
    expr: sum(openstack_compute_stuck_instances_count_gauge{vm_state="stopping"}) BY (host) > 0

  - record: OpenstackNovaInstanceStuckStarting
    expr: sum(openstack_compute_stuck_instances_count_gauge{vm_state="starting"})

  - record: OpenstackNovaInstanceStuckSpawning
    expr: sum(openstack_compute_stuck_instances_count_gauge{vm_state="spawning"}) BY (host) > 0

  - record: OpenstackNovaInstanceStuckRebooting
    expr: sum(openstack_compute_stuck_instances_count_gauge{vm_state="rebooting"}) BY (host) > 0

  - record: OpenstackNovaApiDown
    expr: blackbox_api_status_gauge{check=~"nova"} == 1

  - record: OpenstackNovaApiFlapping
    expr: changes(blackbox_api_status_gauge{check=~"nova"}[30m]) > 8

  - record: OpenstackNovaDatapathDown
    expr: blackbox_datapath_status_gauge{service=~"nova"} == 1

  - record: OpenstackNovaDatapathHalfDown
    expr: blackbox_datapath_status_gauge{service=~"nova"} == 0.5

  - record: OpenstackNovaDatapathFlapping
    expr: changes(blackbox_datapath_status_gauge{service=~"nova"}[30m]) > 8

  - record: OpenstackNovaDatapathJumpHostDown
    expr: blackbox_canary_status_gauge{check=~"ping_jump-.+"} == 1

  - record: OpenstackNovaCanaryDown
    expr: blackbox_canary_status_gauge{service=~"nova"} == 1

  - record: OpenstackNovaCanaryTimeout
    expr: blackbox_canary_status_gauge{service=~"nova"} == 0.5

  - record: OpenstackNovaCanaryFlapping
    expr: changes(blackbox_canary_status_gauge{service=~"nova"}[2h]) > 8

  - record: OpenstackNovaIntegrityHypervisorDown
    expr: blackbox_integrity_status_gauge{check=~"host_status-.+"} == 1
  
