#!/usr/bin/env bash

set -Eeuo pipefail

eval $(
  cat /etc/nova/nova.conf | grep -Pzo '\[keystone_authtoken\][^[]*' | tr -d '\000' | grep '=' |
  while read LINE; do var="${LINE% =*}"
  val="${LINE#*= }"
  echo export OS_${var^^}=${val}
  done)

export OS_IDENTITY_API_VERSION=3

openstack compute service list -f csv --quote none |
  grep -E ',nova-conductor,nova-conductor,|,nova-scheduler,nova-scheduler,' |
  cut -d, -f1 |
  xargs openstack compute service delete
