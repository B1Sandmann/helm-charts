groups:
- name: openstack-keystone-slo.rules
  rules:
  - record: app:api_error_ratio_slo:percent
    labels:
        app: "keystone-api"
    expr: 0.1
  - record: app:api_apdex_slo:percent
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: 80
  - record: app:api_apdex_slo:percent
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: 80

  - record: app:api_error_ratio_sli:ratio_rate5m
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[5m])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[5m]))

  - record: app:api_error_ratio_sli:ratio_rate30m
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[30m])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[30m]))

  - record: app:api_error_ratio_sli:ratio_rate1h
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[1h])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[1h]))

  - record: app:api_error_ratio_sli:ratio_rate2h
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[2h])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[2h]))

  - record: app:api_error_ratio_sli:ratio_rate6h
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[6h])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[6h]))

  - record: app:api_error_ratio_sli:ratio_rate1d
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[1d])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[1d]))

  - record: app:api_error_ratio_sli:ratio_rate3d
    labels:
        app: "keystone-api"
    expr: |2
        sum(increase(nginx_ingress_controller_requests{ingress="keystone", status!~"5.."}[3d])) /  sum(increase(nginx_ingress_controller_requests{ingress="keystone"}[3d]))

  - record: app:api_apdex_sli:rate5m
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[5m])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[5m]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[5m]))

  - record: app:api_apdex_sli:rate30m
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[30m])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[30m]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[30m]))

  - record: app:api_apdex_sli:rate1h
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[1h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[1h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[1h]))

  - record: app:api_apdex_sli:rate2h
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[2h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[2h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[2h]))

  - record: app:api_apdex_sli:rate6h
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[6h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[6h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[6h]))


  - record: app:api_apdex_sli:rate1d
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[1d])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[1d]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[1d]))

  - record: app:api_apdex_sli:rate3d
    labels:
        app: "keystone-api"
        api: "token-create"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="authenticate"}[3d])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[3d]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"authenticate"}[3d]))

  - record: app:api_apdex_sli:rate5m
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[5m])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[5m]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[5m]))

  - record: app:api_apdex_sli:rate30m
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[30m])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[30m]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[30m]))

  - record: app:api_apdex_sli:rate1h
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[1h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[1h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[1h]))

  - record: app:api_apdex_sli:rate2h
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[2h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[2h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[2h]))

  - record: app:api_apdex_sli:rate6h
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[6h])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[6h]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[6h]))


  - record: app:api_apdex_sli:rate1d
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[1d])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[1d]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[1d]))

  - record: app:api_apdex_sli:rate3d
    labels:
        app: "keystone-api"
        api: "token-validate"
    expr: |2
        (sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="0.1", target_type_uri=~"^data/security/auth/tokens", action="read/list"}[3d])) + sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="1", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[3d]))) / 2 / sum(rate(openstack_watcher_api_requests_duration_seconds_bucket{le="+Inf", target_type_uri=~"^data/security/auth/tokens", action=~"read/list"}[3d]))