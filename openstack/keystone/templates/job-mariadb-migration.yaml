{{- if .Values.run_mariabdb_migration }}
apiVersion: batch/v1
kind: Job
metadata:
  name: keystone-mariadb-migration-job
  labels:
    app: {{ template "fullname" . }}
    component: keystone
    type: config
spec:
  backoffLimit: 1
  template:
    spec:
{{- if .Values.rbac.enabled }}
      serviceAccountName: keystone-migration
{{- end }}
      restartPolicy: Never
      containers:
        - name: keystone-mariadb-migration
          image: hub.global.cloud.sap/d062392/keystone-mariadb-migration:latest
          imagePullPolicy: Always
          command:
            - kubernetes-entrypoint
          env:
            - name: COMMAND
              value: "/psql2mysql.sh"
            - name: NAMESPACE
              value: {{ .Release.Namespace }}
            - name: DEPENDENCY_SERVICE
              value: keystone-mariadb,keystone-postgresql
{{- if or .Values.run_db_migration }}
            - name: DEPENDENCY_JOBS
              value: keystone-job-migration
{{- end }}
            - name: SERVICE
              value: keystone
            - name: POSTGRES_URL
              value: postgresql://{{ default .Release.Name .Values.global.dbUser }}:{{ .Values.global.dbPassword }}@{{if .Values.global.clusterDomain }}{{.Release.Name}}-postgresql.{{.Release.Namespace}}.svc.{{.Values.global.clusterDomain}}{{ else }}{{.Release.Name}}-postgresql.{{.Release.Namespace}}.svc.kubernetes.{{.Values.global.region}}.{{.Values.global.tld}}{{- end -}}:5432/{{ default .Release.Name .Values.postgresql.postgresDatabase }}
            - name: MARIADB_URL
              value: mysql+pymysql://{{ default .Release.Name .Values.global.dbUser }}:{{.Values.global.dbPassword }}@{{- if .Values.global.clusterDomain }}{{.Release.Name}}-mariadb.{{.Release.Namespace}}.svc.{{.Values.global.clusterDomain}}{{ else }}{{.Release.Name}}-mariadb.{{.Release.Namespace}}.svc.kubernetes.{{.Values.global.region}}.{{.Values.global.tld}}{{- end -}}/{{ default .Release.Name .Values.mariadb.name }}?charset=utf8
            - name: REPLICA_COUNT
              value: "{{ .Values.api.replicas }}"
            - name: BACKUP
              value: "{{ .Values.postgresql.backup.enabled }}"
{{- end }}
